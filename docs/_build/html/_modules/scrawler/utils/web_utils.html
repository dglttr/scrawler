<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <meta name="generator" content="sphinx-3.5.4, furo 2021.04.11.beta34"/>
        <title>scrawler.utils.web_utils - scrawler 0.3.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/styles/furo.css?digest=59ab60ac09ea94ccfe6deddff6d715cce948a6fc">
    <link rel="stylesheet" href="../../../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" href="../../../_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">scrawler 0.3.0 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">scrawler 0.3.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../built_in_data_extractors.html">Built-in Data Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_data_extractors.html">Custom Data Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Reference</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <h1>Source code for scrawler.utils.web_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">"""Functions for web operations (e. g. working with URLs and retrieving data from websites)."""</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">from</span> <span class="nn">urllib.robotparser</span> <span class="kn">import</span> <span class="n">RobotFileParser</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">tld</span>
<span class="kn">import</span> <span class="nn">tld.exceptions</span>
<span class="kn">import</span> <span class="nn">aiohttp</span>

<span class="kn">from</span> <span class="nn">scrawler.defaults</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DEFAULT_REQUEST_TIMEOUT</span><span class="p">,</span> <span class="n">DEFAULT_REQUEST_TLS_VERIFICATION</span><span class="p">)</span>


<span class="c1"># CONSTANTS</span>
<span class="n">DEFAULT_URL_SCHEMES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"http:"</span><span class="p">,</span> <span class="s2">"https:"</span><span class="p">)</span>
<span class="n">DEFAULT_TEXT_FILE_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"html"</span><span class="p">,</span> <span class="s2">"htm"</span><span class="p">,</span> <span class="s2">"php"</span><span class="p">,</span> <span class="s2">"cfm"</span><span class="p">,</span> <span class="s2">"shtml"</span><span class="p">,</span> <span class="s2">"xhtml"</span><span class="p">,</span> <span class="s2">"asp"</span><span class="p">,</span> <span class="s2">"aspx"</span><span class="p">,</span> <span class="s2">"axd"</span><span class="p">,</span> <span class="s2">"asx"</span><span class="p">,</span> <span class="s2">"asmx"</span><span class="p">,</span> <span class="s2">"ashx"</span><span class="p">,</span> <span class="s2">"jsp"</span><span class="p">)</span>
<span class="n">DEFAULT_MEDIA_FILE_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"pdf"</span><span class="p">,</span> <span class="s2">"xml"</span><span class="p">,</span> <span class="s2">"jpg"</span><span class="p">,</span> <span class="s2">"jpeg"</span><span class="p">,</span> <span class="s2">"png"</span><span class="p">,</span> <span class="s2">"svg"</span><span class="p">,</span> <span class="s2">"gif"</span><span class="p">,</span> <span class="s2">"tiff"</span><span class="p">,</span> <span class="s2">"tif"</span><span class="p">,</span> <span class="s2">"ico"</span><span class="p">,</span> <span class="s2">"mp4"</span><span class="p">,</span> <span class="s2">"mp3"</span><span class="p">,</span>
                                 <span class="s2">"zip"</span><span class="p">,</span> <span class="s2">"exe"</span><span class="p">,</span> <span class="s2">"avi"</span><span class="p">,</span> <span class="s2">"css"</span><span class="p">,</span> <span class="s2">"doc"</span><span class="p">,</span> <span class="s2">"docx"</span><span class="p">,</span> <span class="s2">"mid"</span><span class="p">,</span> <span class="s2">"midi"</span><span class="p">,</span> <span class="s2">"mpg"</span><span class="p">,</span> <span class="s2">"mpeg"</span><span class="p">,</span> <span class="s2">"mov"</span><span class="p">,</span> <span class="s2">"qt"</span><span class="p">,</span>
                                 <span class="s2">"ram"</span><span class="p">,</span> <span class="s2">"rar"</span><span class="p">,</span> <span class="s2">"txt"</span><span class="p">,</span> <span class="s2">"wav"</span><span class="p">,</span> <span class="s2">"7z"</span><span class="p">,</span> <span class="s2">"tar.gz"</span><span class="p">,</span> <span class="s2">"bin"</span><span class="p">,</span> <span class="s2">"dmg"</span><span class="p">,</span> <span class="s2">"iso"</span><span class="p">,</span> <span class="s2">"csv"</span><span class="p">,</span> <span class="s2">"dat"</span><span class="p">,</span> <span class="s2">"db"</span><span class="p">,</span>
                                 <span class="s2">"dbf"</span><span class="p">,</span> <span class="s2">"log"</span><span class="p">,</span> <span class="s2">"mdb"</span><span class="p">,</span> <span class="s2">"sql"</span><span class="p">)</span>    <span class="c1"># this list is not complete, but should cover the most frequent file extensions</span>
<span class="n">DEFAULT_ALLOWED_HTTP_CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">"text/html"</span>


<div class="viewcode-block" id="async_get_html"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.async_get_html">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">async_get_html</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span>
                         <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">DEFAULT_REQUEST_TLS_VERIFICATION</span><span class="p">,</span>
                         <span class="n">max_content_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">check_http_content_type</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">return_response_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">raise_for_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientResponse</span><span class="p">]]:</span>
    <span class="sd">"""Collect HTML text of a given URL.</span>

<span class="sd">    :param url: URL to retrieve the HTML from.</span>
<span class="sd">    :param session: :class:`aiohttp:aiohttp.ClientSession` to be used for making the request asynchronously.</span>
<span class="sd">    :param user_agent: Allows to optionally specify a different user agent than the default Python user agent.</span>
<span class="sd">    :param verify: Whether to verify the server's TLS certificate. Useful if TLS connections fail, but should in general be ``True`` to avoid man-in-the-middle attacks.</span>
<span class="sd">    :param max_content_length: Check the HTTP header for the attribute ``content-length``. If it is bigger than this specified parameter, a ValueError is raised. Set to ``-1`` when not needed.</span>
<span class="sd">    :param check_http_content_type: Whether to check the HTTP header field ``content-type``. If it does not include ``text``, a ValueError is raised.</span>
<span class="sd">    :param return_response_object: If True, also returns the ClientResponse object from the GET request.</span>
<span class="sd">    :param raise_for_status: If True, raise an HTTPError if the HTTP request returned an unsuccessful status code.</span>
<span class="sd">    :param kwargs: Will be passed on to :meth:`aiohttp:aiohttp.ClientSession.get`.</span>
<span class="sd">    :return: HTML text from the given URL. Optionally also returns the HTTP response object.</span>
<span class="sd">    :raises aiohttp.ClientError, aiohttp.HTTPError, ValueError:</span>
<span class="sd">        Errors derived from :class:`aiohttp:aiohttp.ClientError` include ``InvalidURL``, ``ClientConnectionError`` and ``ClientResponseError``.</span>
<span class="sd">        May optionally raise ``aiohttp.HTTPError`` (if ``raise_for_status`` is ``True``)</span>
<span class="sd">        or ValueError (if ``check_http_content_type`` or ``max_content_length`` are ``True``).</span>
<span class="sd">    """</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">user_agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">"user_agent"</span><span class="p">:</span> <span class="n">user_agent</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">raise_for_status</span><span class="o">=</span><span class="n">raise_for_status</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="c1"># Check if a different content type is declared in the HTTP header, e.g. 'application/pdf'</span>
        <span class="k">if</span> <span class="n">check_http_content_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"content-type"</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"content-type"</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DEFAULT_ALLOWED_HTTP_CONTENT_TYPE</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Content type is not text: </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Check if the content_length declared in the HTTP header exceeds the maximum specified in the method.</span>
        <span class="k">if</span> <span class="n">max_content_length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"content-length"</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"content-length"</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="n">max_content_length</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Content length larger than specified length: Specified: </span><span class="si">{</span><span class="n">max_content_length</span><span class="si">}</span><span class="se">\t</span><span class="s2">Found: </span><span class="si">{</span><span class="n">content_length</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_response_object</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="extract_same_host_pattern"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.extract_same_host_pattern">[docs]</a><span class="k">def</span> <span class="nf">extract_same_host_pattern</span><span class="p">(</span><span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Looks at the passed base/start URL to determine which mode for :func:`is_same_host` is appropriate.</span>
<span class="sd">        First looks at whether the given URL contains a non-empty path. If one is found, the number of directories ``X`` is counted and ``directoryX`` is returned.</span>
<span class="sd">        Otherwise, check whether the URL contains subdomains. If found, the number of subdomains ``X`` is counted and ``subdomainX`` is returned.</span>
<span class="sd">        If neither exist, returns ``fld``.</span>

<span class="sd">        .. seealso:: :func:`is_same_host`</span>
<span class="sd">    """</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">ParsedUrl</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>

    <span class="n">path_cleaned</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span>
    <span class="n">path_cleaned</span> <span class="o">=</span> <span class="n">path_cleaned</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">path_cleaned</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"/"</span> <span class="k">else</span> <span class="n">path_cleaned</span>   <span class="c1"># remove leading '/' TODO in the future replace with `removeprefix()` (&gt;= Python 3.9)</span>
    <span class="n">path_cleaned</span> <span class="o">=</span> <span class="n">path_cleaned</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">path_cleaned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">"/"</span> <span class="k">else</span> <span class="n">path_cleaned</span>   <span class="c1"># remove trailing '/' TODO in the future replace with `removesuffix()` (&gt;= Python 3.9)</span>
    <span class="n">path_cleaned</span> <span class="o">=</span> <span class="n">path_cleaned</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">"."</span> <span class="ow">in</span> <span class="n">path_cleaned</span><span class="p">)</span> <span class="k">else</span> <span class="s2">"/"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># if URL points to a file, use the directory of the file</span>

    <span class="n">subdomain_cleaned</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"www1."</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"www."</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"www1"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"www"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>  <span class="c1"># first replace www with dot, then without</span>
    <span class="k">if</span> <span class="n">path_cleaned</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>  <span class="c1"># check for subdirectories</span>
        <span class="n">subdirectory_depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"directory</span><span class="si">{</span><span class="n">subdirectory_depth</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">elif</span> <span class="n">subdomain_cleaned</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>   <span class="c1"># check for subdomains</span>
        <span class="n">no_subdomains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdomain_cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"subdomain</span><span class="si">{</span><span class="n">no_subdomains</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c1"># if nothing else matches, use full domain</span>
        <span class="k">return</span> <span class="s2">"fld"</span></div>


<div class="viewcode-block" id="filter_urls"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.filter_urls">[docs]</a><span class="k">def</span> <span class="nf">filter_urls</span><span class="p">(</span><span class="n">urls</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">,</span>
                <span class="n">filter_non_standard_schemes</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">filter_media_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">blocklist</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">,</span>
                <span class="n">filter_foreign_urls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">callable</span><span class="p">],</span>
                <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">return_discarded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">set</span><span class="p">,</span> <span class="nb">set</span><span class="p">]]:</span>
    <span class="sd">"""Filter a list of URLs along some given attributes.</span>

<span class="sd">    :param urls: List of URLs to filter.</span>
<span class="sd">    :param filter_non_standard_schemes: If ``True``, makes sure that the URLs start with ``http:`` or ``https:``.</span>
<span class="sd">    :param filter_media_files: If ``True``, discards URLs having media file extensions like ``.pdf`` or ``.jpeg``. For details, see :func:`is_media_file`.</span>
<span class="sd">    :param blocklist: Specify a list of words or parts that if they appear in a URL, the URL will be discarded (e. g. 'git.', datasets.').</span>
<span class="sd">    :param filter_foreign_urls: Specify how to detect foreign URLs.</span>
<span class="sd">        Can either be a string that is passed to :func:`is_same_host()`, or a custom ``Callable`` that has to include two arguments, ``url1`` and ``url2``.</span>
<span class="sd">        For details on possible strings see :func:`is_same_host()` (note that the ``base_url`` parameter has to be passed for this to work).</span>
<span class="sd">        If you pass your own comparison function here, it has to include two parameters, ``url1`` and ``url2``.</span>
<span class="sd">        The first URL is the one to be checked, and the second is the reference (the crawling start URL). This function</span>
<span class="sd">        should return ``True`` for URLs that belong to the same host, and ``False`` for foreign URLs.</span>
<span class="sd">    :param base_url: Used in conjunction with the ``filter_foreign_urls`` parameter to detect foreign URLs.</span>
<span class="sd">    :param return_discarded: If ``True``, also returns to discarded URLs.</span>
<span class="sd">    :return: ``Set`` containing URLs that were not filtered. Optionally also returns discarded URLs.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">       .. autosummary::</span>
<span class="sd">          :nosignatures:</span>

<span class="sd">          is_media_file</span>
<span class="sd">          is_same_host</span>
<span class="sd">    """</span>
    <span class="n">filtered</span><span class="p">,</span> <span class="n">discarded</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filter_non_standard_schemes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DEFAULT_URL_SCHEMES</span><span class="p">):</span>
            <span class="n">discarded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">filter_media_files</span> <span class="ow">and</span> <span class="n">is_media_file</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="n">discarded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">el</span> <span class="ow">in</span> <span class="n">url</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">blocklist</span><span class="p">]):</span>
            <span class="n">discarded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">base_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_foreign_urls</span><span class="p">,</span> <span class="n">Callable</span><span class="p">):</span>
                <span class="n">same_host</span> <span class="o">=</span> <span class="n">filter_foreign_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">base_url</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">same_host</span> <span class="o">=</span> <span class="n">is_same_host</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">filter_foreign_urls</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">same_host</span><span class="p">:</span>
                <span class="n">discarded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="n">filtered</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_discarded</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">discarded</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filtered</span></div>


<div class="viewcode-block" id="fix_relative_urls"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.fix_relative_urls">[docs]</a><span class="k">def</span> <span class="nf">fix_relative_urls</span><span class="p">(</span><span class="n">urls</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
    <span class="sd">"""Make relative URLs absolute by joining them with the base URL that they were found on."""</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fixed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># catch invalid URLs</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">fixed</span></div>


<div class="viewcode-block" id="get_html"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.get_html">[docs]</a><span class="k">def</span> <span class="nf">get_html</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_REQUEST_TIMEOUT</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">DEFAULT_REQUEST_TLS_VERIFICATION</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">max_content_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">check_http_content_type</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">return_response_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">raise_for_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">"""Collect HTML text of a given URL.</span>

<span class="sd">    :param url: URL to retrieve the HTML from.</span>
<span class="sd">    :param timeout: If the server does not answer for the number of seconds specified here, a :class:`Timeout` exception is raised.</span>
<span class="sd">    :param user_agent: Allows to optionally specify a different user agent than the default Python user agent.</span>
<span class="sd">    :param verify: Whether to verify the server's TLS certificate. Useful if TLS connections fail, but should in general be ``True`` to avoid man-in-the-middle attacks.</span>
<span class="sd">    :param stream: If ``True``, only the header of the response is retrieved. This allows for HTTP content type checking before actually retrieving the content. For details see the `Requests documentation &lt;https://2.python-requests.org/en/master/user/advanced/#id9&gt;`__.</span>
<span class="sd">    :param max_content_length: Check the HTTP header for the attribute ``content-length``. If it is bigger than this specified parameter, a ``ValueError`` is raised. Set to ``-1`` when not needed.</span>
<span class="sd">    :param check_http_content_type: Check the HTTP header for the attribute ``content-type``. If it does not include 'text', a ``ValueError`` is raised.</span>
<span class="sd">    :param return_response_object: If ``True``, also returns the ``Response`` object from the GET request.</span>
<span class="sd">    :param raise_for_status: If ``True``, raise an ``HTTPError`` if the HTTP request returned an unsuccessful status code.</span>
<span class="sd">    :return: HTML text from the given URL.</span>
<span class="sd">    :raises ConnectionError, Timeout, other RequestExceptions, HTTPError, ValueError: Raises some errors from the</span>
<span class="sd">        requests library when retrieval errors occur. Optionally raises ``HTTPError`` (if ``raise_for_status`` is ``True``) and</span>
<span class="sd">        ``ValueError`` (if ``check_http_content_type`` or ``max_content_length`` are ``True``).</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"user_agent"</span><span class="p">:</span> <span class="n">user_agent</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">raise_for_status</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># throw an exception if HTTP requests returned an unsuccessful status code</span>

    <span class="c1"># Check if a different content type is declared in the HTTP header, e.g. 'application/pdf'</span>
    <span class="k">if</span> <span class="n">check_http_content_type</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"content-type"</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DEFAULT_ALLOWED_HTTP_CONTENT_TYPE</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Content type is not text: </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># Don't do anything if the attribute is not specified in the header</span>
            <span class="k">pass</span>

    <span class="c1"># Check if the content_length declared in the HTTP header exceeds the maximum specified in the method.</span>
    <span class="k">if</span> <span class="n">max_content_length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"content-length"</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="n">max_content_length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Content length larger than specified length: Specified: </span><span class="si">{</span><span class="n">max_content_length</span><span class="si">}</span><span class="se">\t</span><span class="s2">Found: </span><span class="si">{</span><span class="n">content_length</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># Don't do anything if the attribute is not specified in the header</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">return_response_object</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></div>


<div class="viewcode-block" id="async_get_redirected_url"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.async_get_redirected_url">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">async_get_redirected_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span> <span class="n">max_redirects_to_follow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Find final, redirected URL. Supports both HTTP redirects and HTML redirects. Also follows up on multiple redirects.</span>

<span class="sd">    :param url: Original URL.</span>
<span class="sd">    :param session: ``aiohttp.ClientSession`` to be used for making the request asynchronously.</span>
<span class="sd">    :param max_redirects_to_follow: Maximum number of redirects to follow to guard against infinite redirects. If limit is reached, ``None`` is returned.</span>
<span class="sd">    :param kwargs: Passed on to :func:`async_get_html`.</span>
<span class="sd">    :returns: URL after redirects. If URL is invalid or an error occurs, returns ``None``.</span>
<span class="sd">    """</span>
    <span class="n">redirect_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_get_html</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">max_redirects</span><span class="o">=</span><span class="n">max_redirects_to_follow</span><span class="p">,</span>
                                              <span class="n">return_response_object</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># HTML redirect (see https://www.w3docs.com/snippets/html/how-to-redirect-a-web-page-in-html.html)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">'&lt;meta.*http-equiv.*refresh.*'</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">redirect_tag</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">'&lt;meta.*http-equiv.*refresh.*'</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># extract HTML refresh meta tag</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.*url.*='</span><span class="p">,</span> <span class="n">redirect_tag</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># extract URL part</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">final_url</span><span class="p">)</span>    <span class="c1"># make sure relative URLs are fixed</span>
        <span class="c1"># Redirect in HTTP refresh header</span>
        <span class="k">elif</span> <span class="s2">"Refresh"</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.*url.*='</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Refresh"</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">final_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># Possibly (recursively) follow redirects and re-fetch</span>
        <span class="k">if</span> <span class="n">final_url</span> <span class="o">!=</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">redirect_counter</span> <span class="o">&lt;=</span> <span class="n">max_redirects_to_follow</span><span class="p">:</span>     <span class="c1"># guard against infinite redirects</span>
                <span class="n">redirect_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">final_url</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_get_redirected_url</span><span class="p">(</span><span class="n">final_url</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">max_redirects_to_follow</span><span class="o">=</span><span class="n">max_redirects_to_follow</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Too many redirects on URL </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unable to retrieve redirected URL from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">. Details: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">final_url</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\t</span><span class="s2">URL after redirects: </span><span class="si">{</span><span class="n">final_url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_url</span></div>


<div class="viewcode-block" id="get_redirected_url"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.get_redirected_url">[docs]</a><span class="k">def</span> <span class="nf">get_redirected_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_redirects_to_follow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Find final, redirected URL. Supports both HTTP redirects and HTML redirects. Also follows up on multiple redirects.</span>

<span class="sd">    :param url: Original URL.</span>
<span class="sd">    :param max_redirects_to_follow: Maximum number of redirects to follow to guard against infinite redirects. If limit is reached, ``None`` is returned.</span>
<span class="sd">    :param kwargs: Passed on to :func:`get_html`.</span>
<span class="sd">    :returns: URL after redirects. If URL is invalid or an error occurs, returns ``None``.</span>
<span class="sd">    """</span>
    <span class="n">redirect_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">get_html</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">return_response_object</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># HTML redirect (see https://www.w3docs.com/snippets/html/how-to-redirect-a-web-page-in-html.html)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">'&lt;meta.*http-equiv.*refresh.*'</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">redirect_tag</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">'&lt;meta.*http-equiv.*refresh.*'</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># extract HTML refresh meta tag</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.*url.*='</span><span class="p">,</span> <span class="n">redirect_tag</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># extract URL part</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">final_url</span><span class="p">)</span>    <span class="c1"># make sure relative URLs are fixed</span>
        <span class="c1"># Redirect in HTTP refresh header</span>
        <span class="k">elif</span> <span class="s2">"Refresh"</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.*url.*='</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Refresh"</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">final_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># Possibly (recursively) follow redirects and re-fetch</span>
        <span class="k">if</span> <span class="n">final_url</span> <span class="o">!=</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">redirect_counter</span> <span class="o">&lt;=</span> <span class="n">max_redirects_to_follow</span><span class="p">:</span>     <span class="c1"># guard against infinite redirects</span>
                <span class="n">redirect_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">final_url</span> <span class="o">=</span> <span class="n">get_redirected_url</span><span class="p">(</span><span class="n">final_url</span><span class="p">,</span> <span class="n">max_redirects_to_follow</span><span class="o">=</span><span class="n">max_redirects_to_follow</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Too many redirects on URL </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unable to retrieve redirected URL from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">. Details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">final_url</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\t</span><span class="s2">URL after redirects: </span><span class="si">{</span><span class="n">final_url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_url</span></div>


<div class="viewcode-block" id="async_get_robot_file_parser"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.async_get_robot_file_parser">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">async_get_robot_file_parser</span><span class="p">(</span><span class="n">start_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">RobotFileParser</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">"""Returns :class:`~python:urllib.robotparser.RobotFileParser` from given URL.</span>
<span class="sd">    If no ``robots.txt`` file is found or error occurs, returns ``None``.</span>

<span class="sd">    :param start_url: URL from which ``robots.txt`` will be collected.</span>
<span class="sd">    :param session: ``aiohttp.ClientSession`` to use for making the request.</span>
<span class="sd">    :param kwargs: Will be passed to :func:`get_html`.</span>
<span class="sd">    :returns:</span>
<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">ParsedUrl</span><span class="p">(</span><span class="n">start_url</span><span class="p">)</span>

        <span class="n">robot_txt_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span><span class="si">}</span><span class="s2">/robots.txt"</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">RobotFileParser</span><span class="p">(</span><span class="n">robot_txt_url</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_get_html</span><span class="p">(</span><span class="n">robot_txt_url</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">check_http_content_type</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">return_response_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_for_status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">]</span>
        <span class="n">rp</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rp</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Exceptions from URL parsing, HTML retrieval and robot file parsing</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unable to retrieve robots.txt from </span><span class="si">{</span><span class="n">start_url</span><span class="si">}</span><span class="s2">. Reason: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_robot_file_parser"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.get_robot_file_parser">[docs]</a><span class="k">def</span> <span class="nf">get_robot_file_parser</span><span class="p">(</span><span class="n">start_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">RobotFileParser</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">"""Returns :class:`~python:urllib.robotparser.RobotFileParser` object from given URL.</span>
<span class="sd">    If no ``robots.txt`` file is found or error occurs, returns ``None``.</span>

<span class="sd">    :param start_url: URL from which ``robots.txt`` will be collected.</span>
<span class="sd">    :param kwargs: Will be passed to :func:`get_html`.</span>

<span class="sd">    .. seealso:: :func:`async_get_robot_file_parser`</span>
<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">ParsedUrl</span><span class="p">(</span><span class="n">start_url</span><span class="p">)</span>

        <span class="n">robot_txt_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span><span class="si">}</span><span class="s2">/robots.txt"</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">RobotFileParser</span><span class="p">(</span><span class="n">robot_txt_url</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">get_html</span><span class="p">(</span><span class="n">robot_txt_url</span><span class="p">,</span> <span class="n">check_http_content_type</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_response_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">raise_for_status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">]</span>
        <span class="n">rp</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rp</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Exceptions from URL parsing, HTML retrieval and robot file parsing</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unable to retrieve robots.txt from </span><span class="si">{</span><span class="n">start_url</span><span class="si">}</span><span class="s2">. Reason: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1"># TODO rethink whether computation is correct</span>
<span class="c1">#  example 1 should return 2, example 2 might return 1</span>
<div class="viewcode-block" id="get_directory_depth"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.get_directory_depth">[docs]</a><span class="k">def</span> <span class="nf">get_directory_depth</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">"""</span>
<span class="sd">    Returns the directory level that a given document is in.</span>
<span class="sd">    For example, ``https://example.com/en/directoryA/document.html`` returns 3,</span>
<span class="sd">    because the ``document.html`` is 3 directories deep into the website's structure.</span>
<span class="sd">    Further, ``https://example.com/en/`` returns 1 (the trailing ``/`` is ignored), and ``https://example.com`` returns 0.</span>

<span class="sd">    :param url: URL to be checked which subdirectory is used.</span>
<span class="sd">    :return: Subdirectory level as path depth. If the URL is invalid, returns ``None``.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"/"</span><span class="p">):</span>   <span class="c1"># to ensure that path does not end with '/', making the length bigger than it is</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">ParsedUrl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldBadUrl</span><span class="p">,</span> <span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldDomainNotFound</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="is_media_file"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.is_media_file">[docs]</a><span class="k">def</span> <span class="nf">is_media_file</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">disallow_approach</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_http_header</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Checks whether the URL ends in a file extension on an allowlist, indicating it is not a media file.</span>

<span class="sd">    :param url: URL to be checked.</span>
<span class="sd">    :param disallow_approach: If ``True``, uses a blocklist-approach, where file extensions known to be media file extensions are blocked.</span>
<span class="sd">        Note that while the blocklist used covers the most frequent file extensions, it certainly is not complete.</span>
<span class="sd">        Using the default allowlist-approach will guarantee no URLs with any but a text file extension are processed.</span>
<span class="sd">    :param check_http_header: Look up the HTTP header attribute ``content-type`` and checks whether it contains ``text/html``.</span>
<span class="sd">        Note that enabling this would make the function execute much slower, because an HTTP request is made</span>
<span class="sd">        instead of just checking a string.</span>
<span class="sd">    :return: ``True``/``False``</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">check_http_header</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"content-type"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">DEFAULT_ALLOWED_HTTP_CONTENT_TYPE</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">ParsedUrl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>    <span class="c1"># this is useful to remove query parameters and fragments</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldBadUrl</span><span class="p">,</span> <span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldDomainNotFound</span><span class="p">):</span>   <span class="c1"># mal-formed URLs</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">"."</span> <span class="ow">in</span> <span class="n">path</span><span class="p">):</span>   <span class="c1"># no dot found -&gt; no file ending exists</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">last_part_of_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">last_part_of_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">disallow_approach</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">DEFAULT_MEDIA_FILE_EXTENSIONS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="ow">or</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">DEFAULT_TEXT_FILE_EXTENSIONS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="is_same_host"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.is_same_host">[docs]</a><span class="k">def</span> <span class="nf">is_same_host</span><span class="p">(</span><span class="n">url1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"hostname"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Checks whether two URLs have the same host. A comparison mode can be defined which determines the parts of the URLs that are checked for equality.</span>

<span class="sd">    :param url1: First URL to compare.</span>
<span class="sd">    :param url2: Second URL to compare.</span>
<span class="sd">    :param mode: String describing which URL parts to check for equality.</span>
<span class="sd">        Can either be any one of the attributes of the :class:`ParsedUrl` class (e.g. ``domain``, ``hostname``, ``fld``).</span>
<span class="sd">        Alternatively, can be set to ``subdomainX`` with ``X`` representing an integer number up to which subdomain the URLs should be compared. E.g., comparing ``http://www.sub.example.com`` and ``http://blog.sub.example.com``, ``sub`` is the first level, while the second levels are ``www`` and ``blog``, respectively.</span>
<span class="sd">        Or, can be set to ``directoryX`` with ``X`` representing an integer number up to which directory the URLs should be compared. E.g., for ``http://example.com/dir1/dir2/index.html``, ``directory2`` would include all files in ``dir2``.</span>
<span class="sd">    :return: ``True`` or ``False``. If exceptions occur, the method returns ``False``.</span>
<span class="sd">    :raises ValueError: If invalid mode is specified.</span>
<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url1</span> <span class="o">=</span> <span class="n">ParsedUrl</span><span class="p">(</span><span class="n">url1</span><span class="p">)</span>
        <span class="n">url2</span> <span class="o">=</span> <span class="n">ParsedUrl</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldBadUrl</span><span class="p">,</span> <span class="n">tld</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TldDomainNotFound</span><span class="p">):</span>   <span class="c1"># URL couldn't be parsed</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">"subdomain\d"</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>  <span class="c1"># equal up to a certain sub-domain specified by an int</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">url1</span><span class="o">.</span><span class="n">fld</span> <span class="o">==</span> <span class="n">url2</span><span class="o">.</span><span class="n">fld</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">url1</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="n">index</span><span class="p">:]</span> <span class="o">==</span> <span class="n">url2</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="n">index</span><span class="p">:]))</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid comparison mode in is_same_host(): </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">. When specifying to check the subdomains, you have to include the subdomain level up to which the comparison will be made. Example: 'subdomain1'."</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">"directory\d"</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>  <span class="c1"># equal up to a certain directory specified by an int</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1"># +1 because path begins with '/' -&gt; first element of split will be empty string ''</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">url1</span><span class="o">.</span><span class="n">hostname</span> <span class="o">==</span> <span class="n">url2</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">url1</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[:</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">url2</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[:</span><span class="n">index</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid comparison mode in is_same_host(): </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">. When specifying to check the directories, you have to include the directory level up to which the comparison will be made. Example: 'directory1'."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url1</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="n">url2</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid comparison mode in is_same_host(): </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">. The comparison attribute you specified does not exist on ParsedUrl. Has to be one of the following: </span><span class="si">{</span><span class="n">ParsedUrl</span><span class="o">.</span><span class="vm">__slots__</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></div>


<div class="viewcode-block" id="strip_unnecessary_url_parts"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.strip_unnecessary_url_parts">[docs]</a><span class="k">def</span> <span class="nf">strip_unnecessary_url_parts</span><span class="p">(</span><span class="n">urls</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fragments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
    <span class="sd">"""Strip unnecessary URL parts.</span>

<span class="sd">    :param urls: URLs to be stripped (can be any Iterable).</span>
<span class="sd">    :param parameters: If ``True``, strips URL query parameters (always start with a ``?``) from the URL.</span>
<span class="sd">    :param fragments: If ``True``, strips URL fragments (introduced with ``#``), except for relevant fragments using Google's hash bang syntax.</span>
<span class="sd">    :return: Iterable of URLs, optionally without (query) parameters.</span>
<span class="sd">    """</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"?"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fragments</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">"#!"</span> <span class="ow">in</span> <span class="n">url</span><span class="p">):</span>   <span class="c1"># Check if Google hash bang syntax is used</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stripped</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stripped</span></div>


<div class="viewcode-block" id="ParsedUrl"><a class="viewcode-back" href="../../../reference.html#scrawler.utils.web_utils.ParsedUrl">[docs]</a><span class="k">class</span> <span class="nc">ParsedUrl</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"url"</span><span class="p">,</span> <span class="s2">"domain"</span><span class="p">,</span> <span class="s2">"subdomain"</span><span class="p">,</span> <span class="s2">"fld"</span><span class="p">,</span> <span class="s2">"tld"</span><span class="p">,</span> <span class="s2">"scheme"</span><span class="p">,</span>
                 <span class="s2">"netloc"</span><span class="p">,</span> <span class="s2">"hostname"</span><span class="p">,</span> <span class="s2">"path"</span><span class="p">,</span> <span class="s2">"query"</span><span class="p">,</span> <span class="s2">"fragment"</span><span class="p">)</span>   <span class="c1"># using __slots__ for performance purposes</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">"""Parse a URL string into its various parts.</span>
<span class="sd">        Basically a wrapper around ``tld.Result`` to make accessing elements easier.</span>

<span class="sd">        :param url: URL string to parse.</span>
<span class="sd">        :raises Exception: Exceptions from `TLD package &lt;https://github.com/barseghyanartur/tld&gt;`__ if the URL is invalid.</span>
<span class="sd">        """</span>
        <span class="n">url_object</span> <span class="o">=</span> <span class="n">tld</span><span class="o">.</span><span class="n">get_tld</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">as_object</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#: Entire URL. In the following, this example URL is used to illustrate the various URL parts:</span>
        <span class="c1">#: ``http://username:password@some.subdomain.example.co.uk/path1/path2?param="abc"#xyz``</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">domain</span>                  <span class="c1">#: ``example`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">subdomain</span>            <span class="c1">#: ``some.subdomain`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fld</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">fld</span>                        <span class="c1">#: ``example.co.uk`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tld</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">tld</span>                        <span class="c1">#: ``co.uk`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span>       <span class="c1">#: ``http`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">netloc</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span>       <span class="c1">#: ``username:password@some.subdomain.example.co.uk`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">hostname</span>   <span class="c1">#: ``some.subdomain.example.co.uk`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span>           <span class="c1">#: ``/path1/path2`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">query</span>         <span class="c1">#: ``param="abc"`` in the example from :attr:`.url`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="n">url_object</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">fragment</span>   <span class="c1">#: ``xyz`` in the example from :attr:`.url`</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"ParsedUrl(url=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">, domain=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">, subdomain=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span><span class="si">}</span><span class="s2">, fld=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fld</span><span class="si">}</span><span class="s2">, tld=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tld</span><span class="si">}</span><span class="s2">, scheme=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">, netloc=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">netloc</span><span class="si">}</span><span class="s2">, hostname=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="si">}</span><span class="s2">, path=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">, query=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">, fragment=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fragment</span><span class="si">}</span><span class="s2">)"</span></div>
</pre></div>
      </article>
      <footer>
        
        <div class="related-pages">
          
          
        </div>

        <div class="related-information">
              Copyright &#169; 2021, Daniel Glatter
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>